
```{r importdata, echo=FALSE}
drake::loadd(tracks)
drake::loadd(track_points)
drake::loadd(c(loc_data, site_data))
my_site <- '125000'
# test <- pull_data(sheet = try)

```


---
output: 
  html_document:
    self_contained: true 
 
params:
  set_title: "My Title!"
title: "Parsnip Watershed Fish Habitat Confirmations"
date: "`r format(Sys.time(), '%B %Y')`"
---


```{r setup, include = TRUE, echo =FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, 
                      fig.align="center", fig.width = 5.118, fig.height = 3.409,
                      fig.path = ('fig/'))

##this is from our title if we want it to autogenerate "Fish Habitat confirmation - PSCIS Crossing `r my_site` - `r pull_data(sheet = loc_data, site = my_site)`"
```


```{r include = FALSE,  message=FALSE}

plot <- drake::r_vis_drake_graph(main = 'Interactive Drake Workflow Graph Showing Project Structure and Dependencies')
```


```{r}
test <- pull_data(sheet = loc_data, site = my_site)

```


```{r}
##need to get basic information
#road name
#tenure holder
#order
#watershed area
#mainstem length
#name stream flows into
#distance from the downstream confluence to the crossing
#fish species known in the stream
#fish species known in downstream system
#amount of habitat upstream of the crossing
#table of the type of habitat upstream
#table of habitat characteristics upstream and downstream

```

# Restoration Candidates {.tabset}

## Overview

```{r}
loadd(table)

names_table <- tibble(old_names = names(table),
                      new_names = c('alias_local_name', 'Site', 'Location', 'Zone (UTM)',
                                    'Easting', 'Northing',
                                    'Stream', 'Channel Width (m)', 'Wetted Width (m)',
                                    'Pool depth (m)','Bankfull Depth (m)', 'Gradient (%)',
                                    'Substrate (dom)', 'Substrate (subdom)', 'Feature',
                                    'utm_zone', 'utm_easting', 'utm_northing'))

names_hab_table <- c('alias_local_name', 'site', 'location', 'gazetted_names','avg_channel_width_m',
         'avg_wetted_width_m', 'average_residual_pool_depth_m',
         'average_bankfull_depth_m','average_gradient_percent',
         'bed_material_dominant', 'bed_material_subdominant')

names_overview_table <- c('alias_local_name', 'site', 'location', 'gazetted_names','zone', 
                          'easting', 'northing')



table_hab <- table %>%
  dplyr::select(all_of(names_hab_table)) %>%
  purrr::set_names(., nm = dplyr::pull(
    dplyr::filter(names_table, 
                  old_names %in% names_hab_table), 
    new_names)) %>% 
  select(-alias_local_name)

table_overview <- table %>%
  dplyr::select(all_of(names_overview_table)) %>%  
  purrr::set_names(., nm = dplyr::pull(
  left_join(as_tibble_col(names_overview_table, column_name = 'old_names'),
               names_table, by = 'old_names'),
            new_names)) %>% 
  select(-alias_local_name) 


##clean up the site_id column of our priorities so we can join to the overview table
priorities <- drake::readd(priorities) %>% 
  tidyr::separate(site_id, into = c('site', 'location'), remove = F)

table_overview <- left_join(
  table_overview, 
  select(priorities,
         site, location, length_surveyed = length, priority, comments),
  by = c('Site' = 'site','Location' = 'location')
) %>%
  select(Site, Stream, Location:Northing, everything())

##add the name of the road and the tenure holder from our pscis sheet
pscis <- drake::readd(pscis)
# 
table_overview <-  left_join(table_overview,
                              select(drake::readd(pscis),
                              pscis_crossing_id, road_name, road_tenure),
                              by = c('Site' = 'pscis_crossing_id')) %>% 
  # filter(priority %ilike% 'high') %>% 
  select(Site, Stream, Location, `Road Name` = road_name, road_tenure, everything()) %>% 
  mutate(Locaton = case_when(Location == 'ds' ~ 'Downstream',
                             Location == 'us' ~ 'Upstream',
                             TRUE ~ Location))

##add the comments from the priorities table



DT::datatable(
  select(table_overview, -length_surveyed),
  caption = 'Table 1: Overview of Parsnip River Watershed with Crossings Assessed with Habitat Confirmations.',
  rownames = FALSE,
    options = list(columnDefs = list(list(
    targets = ncol(table_overview)-2, 
    render = JS(
      "function(data, type, row, meta) {",
      "return type === 'display' && data.length > 20 ?",
      "'<span title=\"' + data + '\">' + data.substr(0, 20) + '...</span>' : data;",
      "}")
  ))))

# names(hab_table) <- pull(table_names, new_names)  

# ##make the hab table for the memo
# table_memo <- table %>% 
#   select(-utm_zone, -utm_easting, -utm_northing)


  # filter(local_name == paste0(my_site, '_us')) %>% 
  # t() %>% 
  # as_tibble()
#   filter(local_name %ilike% my_site) %>% 

# local_name, 
#          avg_channel_width_m, 
#          avg_wetted_width_m,
#          )


```

## Habitat Summaries

```{r}
knitr::kable(
  table_hab
  )
```




```{r }

##Set up for the leaflet map with tracks and track points loaded within the same chunk.  All the packages, functions and plan for data targets is detailed in our .R/ folder.
##here are the indexes of the points


##!!!!!!!!!!!need to change the name of track 57687 in the gpx!!!!!!!!!!!!
track_point_idx_list <- sf::st_intersects(tracks, track_points) %>% 
  purrr::set_names(., nm = pull(tracks, name))

tracks_of_points <- lapply(track_point_idx_list, 
                           make_tracks_of_points, track_points = track_points)


my_tracks <- tracks_of_points %>% 
  keep(names(.) %like% my_site) %>% 
  map(points2line_trajectory)  ##convert our points to lines

# names(my_tracks)
# addPolylines_multi <- function(x){
#     addPolylines(data=x,  opacity=1, color = 'red',
#                    fillOpacity = 0.75, weight=2)
# }

#clean up workspace
rm(track_point_idx_list
   # , tracks_of_points
   )
```

## High Priority Crossings {.tabset}

### PSCIS 125000 

If it doesn't end up being too big each crossing could have its own tab with its own map.  Another and possibly preferable solution might be to have the same map but just different zoom buttons (see zoom button on PSCIS 125000b map) to change the bounding box of the map so that it centers on each individual crossing watershed.

This is a start on a semi-automated write-up for each of the crossings built from our source files.  
PSCIS crossing `r my_site` is located on "link to source" rd, UTM:`r pull_utm(sheet = loc_data, site = my_site)`.

```{r}
knitr::kable(
  table_overview %>% filter(Site %like% my_site)
  )

knitr::kable(
  table_hab %>% filter(Site %like% my_site)
  )
```

```{r}

```

```{r map, out.width = '100%'}
##--------lets map it-----------------------------------------------------------------------
##time to set the watershed code here
##pass it get the watershed boundaries. Dissolve boundaries and display semi-transparent.
##add a culvert measurements output table with all the usual photos
##georeference the upstream and downstream photos from the camera by cross-referencing the time to the gps.


map <- leaflet() %>%
  leaflet(height=500, width=500) %>% 
  addTiles() %>%
    addMouseCoordinates(proj4 = 26911) %>% ##can't seem to get it to render utms yet

  addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>% 
  addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  # addMeasure() %>% 
    # setView(lng = -105.644, lat = 51.618, zoom = 3) 
  addPolylines(data=my_tracks$`125000_us_track1`,  opacity=1, color = 'red',
                   fillOpacity = 0.75, weight=2) %>%
  addPolylines(data=my_tracks$`125000_ds_track`,  opacity=1, color = 'blue',
               fillOpacity = 0.75, weight=2) %>%
  
  addLayersControl(
    baseGroups = c("ESRI Aerial", "Topo"),
    overlayGroups = c(my_tracks$`125000_ds_track`),
    options = layersControlOptions(collapsed = F)) %>% 
  addMiniMap(tiles = providers$"Esri.WorldTopoMap",
             zoomLevelOffset = -6)    # setView(lng = -105.644, lat = 51.618, zoom = 3) ##this becomes the latest and greatest pscis crossing utm
map
```

### PSCIS 125000b

```{r map2}
##--------lets map it-----------------------------------------------------------------------
##easybutton info  https://rstudio.github.io/leaflet/morefeatures.html
map <- leaflet() %>%
  leaflet(height=1000, width=1000) %>% 
  addTiles() %>%
    addMouseCoordinates(epsg = 26911 ) %>% 
  addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>% 
  addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  addPolylines(data=my_tracks$`125000_us_track2`,  opacity=1, color = 'red',
               fillOpacity = 0.75, weight=2) %>%
  # addPolylines(data=my_tracks$`125000_ds_track`,  opacity=1, color = 'blue',
  #              fillOpacity = 0.75, weight=2) %>%
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to Site",
    onClick=JS("function(btn, map){ map.setZoom(12); }"))) %>% 
  addLayersControl(
    baseGroups = c("Topo","ESRI Aerial"),
    overlayGroups = c(my_tracks$`125000_ds_track`),
    options = layersControlOptions(collapsed = T)) %>% 
  # addMouseCoordinates() %>% 
    # setView(lng = -105.644, lat = 51.618, zoom = 3) 
  addMiniMap(tiles = providers$"Esri.WorldTopoMap",
             zoomLevelOffset = -7)
map
```



This is a test to check out tabs


## Workflow Layout



r_vis_drake_graph creates this plot but needs info from configuration file (defaults to the _drake.R file in the main project directory) [Details Here](https://books.ropensci.org/drake/projects.html#safer-interactivity).  Check out how the files in our data folder and the functions in our functions.R file create the outputs that we see.



```{r out.width = '100%'}
plot
```

