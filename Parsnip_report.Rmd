---
output:
  html_document: default
  word_document: default
---

```{r importdata, echo=FALSE}
drake::loadd(tracks)
drake::loadd(c(site_location_data, habitat_data))
source('R/packages.R')  ##should clean up this area
source('R/functions.R')

# test <- pull_data(sheet = try)

```


---
output: 
  html_document:
    self_contained: true 
 
params:
  set_title: "My Title!"
title: "Parsnip Watershed Fish Habitat Confirmations - DRAFT"
date: "`r format(Sys.time(), '%B %Y')`"
---


```{r setup, include = TRUE, echo =FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, 
                      fig.align="center", fig.width = 5.118, fig.height = 3.409,
                      fig.path = ('fig/'))
source('R/packages.R')
source('R/Functions.R')

##this is from our title if we want it to autogenerate "Fish Habitat confirmation - PSCIS Crossing `r my_site` - `r pull_data(sheet = loc_data, site = my_site)`"
```


# Restoration Candidates {.tabset}


```{r priorities_kml}
##here is the kml of the crossings for people to download
##this is one of several kml to be zipped to kmz by the make_kml_geopackage file.
##put this here to line up with the report overview table
table_overview_kml <- drake::readd(table_overview_raw) %>% ##drake::readd(table_overview)
  mutate_at(vars(easting:northing), as.numeric) %>% 
  filter(location %ilike% 'upstream') %>% 
  select(-site_int, -location) %>% 
  mutate(label = paste0(priority, ' priority', '-', site))

##make a kml
sp::coordinates(table_overview_kml) <- ~ easting + northing
sp::proj4string(table_overview_kml) <- sp::CRS("+init=epsg:32610")
table_overview_kml <- reproject(table_overview_kml)

shape = "http://maps.google.com/mapfiles/kml/pal2/icon18.png"


# kml_open("data/priorities_crossings.kml")
# kml_layer(table_overview_kml, shape = shape, colour = priority, labels = label)
# kml_close("data/priorities_crossings.kml")

##see the output
# library(XML)
# xmlRoot(xmlTreeParse("data/priorities_crossings.kml"))[["Document"]]


##also save it in the geopackage so we need as sf
table_overview_sf <- drake::readd(table_overview_raw) %>% 
  sf::st_as_sf(coords = c("easting", "northing"), crs = 26910) %>% 
  mutate(easting = st_coordinates(.)[,1],
         northing = st_coordinates(.)[,2]) %>% 
  select(site,  stream_name, road_name, 'utm_zone', 'easting', 'northing',
         road_tenure, upstr_species, uphab_gross_sub22, everything(), -site_int) %>% 
  filter(location %ilike% 'upstream') %>% 
  st_transform(crs = 4326)
  

##write to the geopackage
# sf::st_write(table_overview_sf, "data/parsnip.gpkg", "priorities", delete_layer = T)


```



## Overview Map


<br>

This interactive report is in the early stages of development, is incomplete and may contain errors.  It is updated regularly and will change substantially in the next few weeks with much more detail yet to be added. The report has been made available at this time for stakeholder engagement to facilitate discussion regarding procurement of an engineering design for replacement of one of the passage restoration candidate culverts. Draft versions of other report components are located <a href="Parsnip_report_intro_methods.html">HERE</a> and will be updated regularly.

<br>

Please contact al@newgraphenvironment.com (2507771518) with feedback and any questions regarding the project. 


<br>

```{r eval=TRUE, out.width= '100%', fig.cap="Overview Map of Parsnip River Watershed fish passage restoration candidates. Field survey tracks are represented by pink lines. Forest tenure roads are orange lines. Details of sites provided in pop-up windows of crossings with photos currently provided for high priority sites."}
##--------lets map it-----------------------------------------------------------------------
##time to set the watershed code here
##pass it get the watershed boundaries. Dissolve boundaries and display semi-transparent.
##add a culvert measurements output table with all the usual photos
##georeference the upstream and downstream photos from the camera by cross-referencing the time to the gps.

loadd(tracks, forest_tenure_road_lines)



#to do later - combine the culvert photos together into one to reduce the clicking.  For now we will just not show some
photo_noshow <- c('upstream', 'downstream', 'inlet', 'inlet2', 
                  'outlet2', 'barrel2', 'barrel_2', 'outlet_2')


#remove photo metadata with no coordinates
photo_metadata <- drake::readd(photo_metadata) %>% 
  filter(!is.na(lat_map)) %>% 
  mutate(base = tools::file_path_sans_ext(filename)) %>% 
  # separate(filename, into = c('base', 'file_extension', sep = '.')) %>% 
  filter(!base %in% photo_noshow)


##make colors for the priorities
pal <- 
   colorFactor(palette = c("red", "yellow", "grey"), 
               levels = c("High", "Moderate", "Low"))

#https://stackoverflow.com/questions/61026700/bring-a-group-of-markers-to-front-in-leaflet
# marker_options <- markerOptions(  
#   zIndexOffset = 1000)
  
  
map <- leaflet(height=500, width=780) %>%
  # leaflet() %>% 
  addTiles() %>%
  leafem::addMouseCoordinates(proj4 = 26910) %>% ##can't seem to get it to render utms yet
  addProviderTiles(providers$"Esri.DeLorme") %>% 
  # addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>% 
  
  # addMeasure() %>% 
  # setView(lng = -105.644, lat = 51.618, zoom = 3)
  
  addPolylines(data=drake::readd(fish_habitat_model_lines),  opacity=1, color = 'blue',
               fillOpacity = 0.75, weight=2) %>% 
  addPolylines(data=forest_tenure_road_lines,  opacity=1, color = '#ff7f00',
               fillOpacity = 0.75, weight=2) %>%
  addPolylines(data=tracks,  opacity=0.75, color = '#e216c4',
               fillOpacity = 0.75, weight=5) %>%
  addLegend(
    position = "topright",
    colors = c("red", "yellow", "grey"),
    labels = c("High", "Moderate", "Low"), opacity = 1,
    title = "Fish Passage Priorities",
  ) %>% 
  addAwesomeMarkers(lng = photo_metadata$lon_map,lat = photo_metadata$lat_map,
                    popup = leafpop::popupImage(photo_metadata$url, src = "remote"),
                    clusterOptions = markerClusterOptions(),
                    labelOptions = offset(c(0,0)),
                    label = paste0(photo_metadata$crossing_id, '_', photo_metadata$filename)) %>%
    addCircleMarkers(
    data=table_overview_sf,
    label = table_overview_sf$site,
    popup = leafpop::popupTable(x = select((table_overview_sf %>% st_set_geometry(NULL)), 
                                           Site = site, Priority = priority, Stream = stream_name, Road = road_name, Comments = comments),
                                feature.id = F,
                                row.numbers = F), 
    radius = 9,
    fillColor = ~pal(priority),
    color= "#ffffff",
    stroke = TRUE, 
    fillOpacity = 1.0,
    weight = 2,
    opacity = 1.0
  ) %>% 
  leafem::addHomeButton(ext = raster::extent(filter(table_overview_sf, priority %ilike% 'High')),
                        position = "topleft",
                        group = 'High Priority Crossings') %>%
    leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '125000')),
                        position = "topleft", 
                        group = '125000') %>% 
      leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '125179')),
                        position = "topleft", 
                        group = '125179') %>% 
        leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '125180')),
                        position = "topleft",
                        group = '125180') %>%
        leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '125186')),
                        position = "topleft",
                        group = '125186') %>%
        leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '125231')),
                        position = "topleft",
                        group = '125231') %>%
        leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '125247')),
                        position = "topleft",
                        group = '125247') %>%
        leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '125253')),
                        position = "topleft",
                        group = '125253') %>%
        leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% '57687')), ##watch out here
                        position = "topleft",
                        group = '125345') %>%
        leafem::addHomeButton(ext = raster::extent(filter(tracks, site %like% 'CV1')),
                        position = "topleft",
                        group = 'CV1') %>%
  addScaleBar(position = 'bottomleft', options = scaleBarOptions(imperial = FALSE)) %>% 
  addLayersControl(
    baseGroups = c(
      "Esri.DeLorme",
      "ESRI Aerial"),
    # overlayGroups = c(my_tracks$`125000_ds_track`),
    options = layersControlOptions(collapsed = F)) %>% 
  
  addMiniMap(tiles = providers$"Esri.NatGeoWorldMap",
             zoomLevelOffset = -6)    # setView(lng = -105.644, lat = 51.618, zoom = 3) ##this becomes the latest and greatest pscis crossing utm
map

```

<br>

Although readers are encouraged to use the interactive maps available here on the webhost as they will be updated regularly, a zip file containing google earth .kml files with crossing locations as well as associated forest tenure roads and railway lines are included for download [HERE AT THIS LINK](https://github.com/NewGraphEnvironment/Parsnip_Fish_Passage/raw/master/data/parsnip_priorities.zip). Please note that data is subject to change and the reporting, maps and kml files will be updated as the report is completed.

<br>


## Overview Table

```{r loadtableoverviewreport}
drake::loadd(table_overview_report)
```


```{r, eval = T}
table_overview_html_all(df = table_overview_report)
```
*Habitat gain based on Fish Habitat Model estimates of linear stream length upstream of crossing with no section of modeled gradients >22% for 100m or more. Estimates currently not adjusted to indicate results from field surveys. Please see individual memos linked in Site column for refined estimates of potential habitat gained based on field surveys and conservative GIS estimates of upstream habitat in mainstem of stream only.

```{r, eval = F}
filter(table_overview_report) %>%
  gt::gt() %>% 
  cols_width(
    vars(Comments) ~ px(300),
    vars(`Habitat Gain (km)`) ~ px(70),
    everything() ~ px(60)
  ) %>% 
  tab_options(table.font.size = 11) %>% 
  tab_footnote(
    footnote = 'Habitat gain modeled based on Fish Habitat Model with 22% gradient threshold for "fish habitat".',
    locations =  cells_column_labels(
      columns = vars(`Habitat Gain (km)`)))
```



```{r loadhabitat}

## Habitat Table
##make habitat table
names_hab_table <- c('alias_local_name', 'site', 'location', 'gazetted_names','avg_channel_width_m',
         'avg_wetted_width_m', 'average_residual_pool_depth_m',
         'average_bankfull_depth_m','average_gradient_percent',
         'bed_material_dominant', 'bed_material_subdominant')


table_habitat_report <- drake::readd(table_habitat_raw) %>%
  dplyr::select(all_of(names_hab_table)) 

table_habitat_report <- left_join(
  table_habitat_report,
  select(drake::readd(priorities_spreadsheet),
         site, location, length_surveyed = length, priority, comments),
  by = c('site','location')
)


  # select(Site, Stream, Location:Northing, everything())

```


```{r makehabtable, eval=F}
new_names <-  c('alias_local_name', 'Site', 'Location', 
                'Stream', 'Channel Width (m)', 'Wetted Width (m)',
                'Pool depth (m)','Bankfull Depth (m)', 'Gradient (%)',
                'Substrate (dominant)', 'Substrate (subdominant)', 'Length Surveyed (m)',
                'Priority', 'Comments')


table_hab_prep <- table_hab %>% 
  purrr::set_names(., nm = new_names) %>% 
   mutate(Location = case_when(Location == 'ds' ~ 'Downstream',
                             TRUE ~ 'Upstream')) %>% 
  select(-alias_local_name, -Stream)
```


```{r eval=FALSE}
##not including now as is maybe too much info.  Probably better to have the info in the overview table
drake::readd(table_habitat_report) %>% 
  gt::gt() %>% 
  tab_header(title="Habitat Summary") %>% 
  cols_width(
    vars(Comments) ~ px(250),
    # vars(`Substrate (dominant)`,`Substrate (subdominant)`) ~ px(75),
    vars(Location) ~ px(66),
    everything() ~ px(50)
  ) %>% 
  tab_options(table.font.size = 11) 



# table_hab_prep %>%
#   gt::gt() %>% 
#   tab_header(title="Habitat Summary") %>% 
#   cols_width(
#     vars(Comments) ~ px(250),
#     # vars(`Substrate (dominant)`,`Substrate (subdominant)`) ~ px(75),
#     vars(Location) ~ px(66),
#     everything() ~ px(50)
#   ) %>% 
#   tab_options(table.font.size = 11) 
```


## High Priority Crossings {.tabset}

### Chuchinka-Arctic FSR {.tabset}
Drone footage for habitat upstream of crossing 125000 is located [here at this link](https://www.youtube.com/watch?v=-foWvX1MSkg) 

```{r site125000}
#### Tributary to Parsnip River - PSCIS 125000 
my_site <- '125000'
```

<br>

```{r}
filter(table_overview_report,
         Site == my_site) %>%
  select(-Comments) %>% 
  gt::gt() %>% 
  tab_header(title="Overview") %>%
  cols_width(
    # vars(Comments) ~ px(300),
    # vars(`Habitat Gain (km)`) ~ px(70),
    everything() ~ px(90)
  ) %>% 
  tab_options(table.font.size = 11) %>% 
  tab_footnote(
    footnote = 'Habitat gain modeled based on Fish Habitat Model with 22% gradient threshold for "fish habitat".',
    locations =  cells_column_labels(
      columns = vars(`Habitat Gain (km)`)))

##DT table is a bit finicky for now
# DT::datatable(
#   filter(table_overview_prep,
#          Site == my_site),
#   rownames = FALSE
#   # options = list(columnDefs = list(list(
#   # targets = ncol(table_overview_prep)-1, 
#   # render = JS(
#   #   "function(data, type, row, meta) {",
#   #   "return type === 'display' && data.length > 20 ?",
#   #   "'<span title=\"' + data + '\">' + data.substr(0, 20) + '...</span>' : data;",
#   #   "}")))
# )

```

<br>

```{r eval=T}
drake::readd(table_habitat_report) %>% 
  filter(Site == my_site) %>% 
  gt::gt() %>% 
  tab_header(title="Habitat Summary") %>% 
  cols_width(
    vars(Comments) ~ px(250),
    # vars(`Substrate (dominant)`,`Substrate (subdominant)`) ~ px(75),
    vars(Location) ~ px(66),
    everything() ~ px(50)
  ) %>% 
  tab_options(table.font.size = 11) 



# filter(table_hab_prep, Site == my_site) %>%
#   gt::gt() %>% 
#   tab_header(title="Habitat Summary") %>% 
#   cols_width(
#     vars(Comments) ~ px(250),
#     vars(`Substrate (dominant)`,`Substrate (subdominant)`) ~ px(75),
#     vars(Location) ~ px(66),
#     everything() ~ px(50)
#   ) %>% 
#   tab_options(table.font.size = 11) 
```

<br>



### Chuchinka-Missinka FSR  {.tabset}

```{r}
filter(table_overview_report,
         Site %in% c('125179', '125180', '125186')) %>%
  select(-Comments) %>% 
  gt::gt() %>% 
  tab_header(title="Overview") %>%
  cols_width(
    # vars(Comments) ~ px(300),
    # vars(`Habitat Gain (km)`) ~ px(70),
    everything() ~ px(90)
  ) %>% 
  tab_options(table.font.size = 11) %>% 
  tab_footnote(
    footnote = 'Habitat gain modeled based on Fish Habitat Model with 22% gradient threshold for "fish habitat".',
    locations =  cells_column_labels(
      columns = vars(`Habitat Gain (km)`)))

```

<br>

```{r eval=T}
filter(drake::readd(table_habitat_report), 
       Site %in% c('125179', '125180', '125186')) %>%
  gt::gt() %>% 
  tab_header(title="Habitat Summary") %>% 
  cols_width(
    vars(Comments) ~ px(250),
    # vars(`Substrate (dominant)`,`Substrate (subdominant)`) ~ px(75),
    vars(Location) ~ px(66),
    everything() ~ px(50)
  ) %>% 
  tab_options(table.font.size = 11) 

```

<br>


### Chuchinka-Table FSR {.tabset}

```{r}
filter(table_overview_report,
         Site %in% c('125231','125247', '125253', 'CV1')) %>%
  mutate_all(~replace_na(.,"-")) %>% 
  select(-Comments) %>% 
  gt::gt() %>% 
  tab_header(title="Overview") %>%
  cols_width(
    # vars(Comments) ~ px(300),
    # vars(`Habitat Gain (km)`) ~ px(70),
    everything() ~ px(90)
  ) %>% 
  tab_options(table.font.size = 11) %>% 
  tab_footnote(
    footnote = 'Habitat gain modeled based on Fish Habitat Model with 22% gradient threshold for "fish habitat".',
    locations =  cells_column_labels(
      columns = vars(`Habitat Gain (km)`)))

```

<br>

```{r eval=T}
filter(drake::readd(table_habitat_report), 
       Site %in% c('125231', '125247', '125253', 'CV1')) %>%
  mutate_all(~replace_na(.,"-")) %>% 
  gt::gt() %>% 
  tab_header(title="Habitat Summary") %>% 
  cols_width(
    vars(Comments) ~ px(250),
    # vars(`Substrate (dominant)`,`Substrate (subdominant)`) ~ px(75),
    vars(Location) ~ px(60),
    everything() ~ px(50)
  ) %>% 
  tab_options(table.font.size = 11) 

```


### Chuchinka-Colbourne FSR {.tabset}


```{r site125345}
my_site <- '125345'

#### Tributary to Missinka River - PSCIS 125180

```


```{r}
filter(table_overview_report,
         Site == my_site) %>%
  select(-Comments) %>% 
  gt::gt() %>% 
  tab_header(title="Overview") %>%
  cols_width(
    # vars(Comments) ~ px(300),
    # vars(`Habitat Gain (km)`) ~ px(70),
    everything() ~ px(90)
  ) %>% 
  tab_options(table.font.size = 11) %>% 
  tab_footnote(
    footnote = 'Habitat gain modeled based on Fish Habitat Model with 22% gradient threshold for "fish habitat".',
    locations =  cells_column_labels(
      columns = vars(`Habitat Gain (km)`)))

```

<br>

```{r eval = T}
filter(drake::readd(table_habitat_report), 
       Site == my_site) %>%
  gt::gt() %>% 
  tab_header(title="Habitat Summary") %>% 
  cols_width(
    vars(Comments) ~ px(250),
    # vars(`Substrate (dominant)`,`Substrate (subdominant)`) ~ px(75),
    vars(Location) ~ px(60),
    everything() ~ px(50)
  ) %>% 
  tab_options(table.font.size = 11) 

```

<br>

## Workflow Layout

The field work procedures and preparation for this project are based on procedures developed by the provincial [Fish Passage Technical Working Group](https://www2.gov.bc.ca/gov/content/environment/natural-resource-stewardship/land-based-investment/investment-categories/fish-passage) in the [Checklist for Habitat Confirmation](https://www2.gov.bc.ca/gov/content/environment/natural-resource-stewardship/land-based-investment/investment-categories/fish-passage/habitat-confirmation-projects).  The checklist was developed to guide biologists confirming fish habitat value at a stream crossings which have been identified as potential high‐priorities for fish passage restoration.

<br>

 * Code and data for the workflow is available at [New Graph Environment Github Site ](https://github.com/NewGraphEnvironment/Parsnip_Fish_Passage).  This report is generated from a Rmarkdown document processing raw data from:

    + [Fish Data Submission Spreadsheet Template - V 2.0, April 16, 2019 ](https://www2.gov.bc.ca/gov/content/environment/plants-animals-ecosystems/fish/fish-and-fish-habitat-data-information/fish-data-submission/submit-fish-data#submitfish) 

    + [pscis_assessment_template_v23.xls](https://www2.gov.bc.ca/gov/content/environment/natural-resource-stewardship/land-based-investment/investment-categories/fish-passage/assessment-projects)

    + Excel spreadsheet with priority level detailed for each of the crossings surveyed.

    + GPS tracks and points from field surveys.  

    + Photos and photo metadata.  When not available in metadata photos georeferenced by aligning photostamp time with GPS track times.

<br>


```{r include = FALSE,  message=FALSE}

plot <- drake::r_vis_drake_graph(targets_only = TRUE, 
                                 main = 'Interactive Workflow Diagram' 
                                 ) #build_times = "none"

```


```{r out.width = '100%'}
plot
```

